<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"> <body><div xmlns="http://www.w3.org/1999/xhtml" tabindex="-1" style="-webkit-transform-origin: 0px 0px; -moz-transform-origin: 0px 0px; -o-transform-origin: 0px 0px; -webkit-transform: rotate(0deg) scale(0.1, 0.1); -moz-transform: rotate(0deg) scale(0.1, 0.1); -o-transform: rotate(0deg) scale(0.1, 0.1); position: absolute; left: 5px; top: 5px; "><div style="overflow: visible; position: absolute; left: 0px; top: 0px; opacity: 1; border: 0px solid rgb(0, 0, 0); padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; width: 850px; height: 820px; " class=""><div class="visibleSelection" style="position: absolute; word-wrap: break-word; font-size: 12pt; font-family: Arial; color: rgb(0, 0, 0); white-space: pre-wrap; max-width: 850px; min-width: 850px; max-height: none; min-height: 0px; " contenteditable="true"><span style="text-decoration: none; outline: none; ">The interesting property of Lively that makes existing caching solutions not fit well is that Lively core concept is to allow changing data and code anytime. In order to still optimize loading we made very good experience with an approach that we call "combined modules". It basically means concatenating the core modules into one file and serving this file as </span><span lively:uri="http://lively-kernel.org/repository/webwerkstatt/core/generated/combinedModules.js" xmlns:lively="http://www.experimentalstuff.com/Lively" style="color: blue; text-decoration: underline; cursor: pointer; outline: none; ">combinedModules.js</span><span style="text-decoration: none; outline: none; ">.

In order to prevent the browser from caching scripts (normally the browser will automatically cache resources when it has already loaded the same URL) we also append a hash string to the URL (to make it unique). When you look at the first scripts that gets loaded at </span><span lively:uri="http://lively-kernel.org/repository/webwerkstatt/webwerkstatt.xhtml" xmlns:lively="http://www.experimentalstuff.com/Lively" style="color: blue; text-decoration: underline; cursor: pointer; outline: none; ">webwerkstatt.xhtml</span><span style="text-decoration: none; outline: none; "> it looks like this URL: </span><span lively:uri="http://lively-kernel.org/repository/webwerkstatt/core/generated/combinedModules.js?fd1317b9543eefb0c2ae82deeaeaf2f8" xmlns:lively="http://www.experimentalstuff.com/Lively" style="color: blue; text-decoration: underline; cursor: pointer; outline: none; ">http://lively-kernel.org/repository/webwerkstatt/core/generated/combinedModules.js?fd1317b9543eefb0c2ae82deeaeaf2f8</span><span style="text-decoration: none; outline: none; ">.

Accordingly, the loading process when bootstrapping Lively looks like this:
</span><span style="font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration: none; color: rgb(0, 0, 128); font-family: Courier; outline: none; ">if</span><span style="color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration: none; font-family: Courier; outline: none; "> (optimizedLoading) </span><span style="font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration: none; color: rgb(0, 128, 0); font-family: Courier; outline: none; ">{</span><span style="color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration: none; font-family: Courier; outline: none; ">
    </span><span style="font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration: none; color: rgb(0, 0, 128); font-family: Courier; outline: none; ">var</span><span style="color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration: none; font-family: Courier; outline: none; "> hashUrl = codeBase + </span><span style="font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration: none; color: rgb(0, 128, 128); font-family: Courier; outline: none; ">'generated/combinedModulesHash.txt'</span><span style="color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration: none; font-family: Courier; outline: none; ">,
        combinedModulesUrl = codeBase + </span><span style="font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration: none; color: rgb(0, 128, 128); font-family: Courier; outline: none; ">'generated/combinedModules.js'</span><span style="color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration: none; font-family: Courier; outline: none; ">,
        hash = JSLoader.getSync(hashUrl, true</span><span style="font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration: none; color: rgb(128, 128, 128); font-family: Courier; outline: none; ">/*uncached*/</span><span style="color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration: none; font-family: Courier; outline: none; ">);
    JSLoader.loadCombinedModules(combinedModulesUrl, thenDoFunc, hash);
    </span><span style="font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration: none; color: rgb(0, 0, 128); font-family: Courier; outline: none; ">return</span><span style="color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration: none; font-family: Courier; outline: none; ">;
</span><span style="font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration: none; color: rgb(0, 128, 0); font-family: Courier; outline: none; ">}</span><span style="text-decoration: none; outline: none; ">

Now the interesting question, how is combinedModules.js created?

We are currently doing this for the webwerkstatt SVN repository in a post-commit hook that looks like this:
</span><span style="text-decoration: none; font-family: Courier; outline: none; ">#!/bin/sh
combineModulesOnCommit.py --repository "$1" --rev $2 &amp;</span><span style="text-decoration: none; outline: none; ">

We are passing the path to SVN repository and the newly commited revision to a script "combineModulesOnCommit.py". You can get it here: </span><span lively:uri="http://lively-kernel.org/other/combineModulesOnCommit.py" xmlns:lively="http://www.experimentalstuff.com/Lively" style="color: blue; text-decoration: underline; cursor: pointer; outline: none; ">http://lively-kernel.org/other/combineModulesOnCommit.py</span><span style="text-decoration: none; outline: none; ">

What the script does is the following:
1. Figure out if the commit changed one of the core files? If not abort
2. Get and concatenate all core modules into one new combinedModules.js file
3. Generate a new hash for that file

What is important when concatenating is the correct order of the modules. Since each module can depend on other modules it is important that dependend modules are inserted before. Since we can only determine this at runtime, Lively provides a method to output the topologically sorted module names:
</span><span style="text-decoration: none; font-family: Courier; outline: none; ">lively.lang.Namespace.bootstrapModulesString();</span><span style="text-decoration: none; outline: none; ">

The result of that is placed inside combineModulesOnCommit.py and used when the concatenation takes place.

(</span><span style="text-decoration: none; font-style: italic; outline: none; ">Note: That we only occasinally update this fixed set of core modules. This is OK since out module system is flexible enough to load in modules during the optimized bootstrap phase that aren't in this fixed set. However, those need to be fetched one-by-one from the server</span><span style="text-decoration: none; outline: none; ">)</span></div></div></div></body></html>